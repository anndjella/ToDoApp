<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToDoApp</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; max-width: 720px; }
    .row { display: flex; gap: 0.5rem; margin: 1rem 0; }
    input, select { padding: 0.6rem; }
    input { flex: 1; }
    button { padding: 0.6rem 1rem; cursor: pointer; }
    ul { padding-left: 1rem; }
    li { cursor: pointer; display: flex; align-items: center; gap: .5rem; margin: .25rem 0; }
    .done { text-decoration: line-through; opacity: 0.7; }
    .tag { font-size: .75rem; padding: .1rem .4rem; border-radius: .4rem; border: 1px solid #ccc; }
    .H { background: #ffe3e3; border-color: #ffb3b3; }
    .M { background: #fff4cc; border-color: #ffd966; }
    .L { background: #e8f5e9; border-color: #b7e1c1; }
    .muted { color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <h1>ToDo App</h1>

  <div class="row">
    <input id="title" placeholder="Add task..." />
    <select id="priority" aria-label="Priority">
      <option value="1">High</option>
      <option value="2" selected>Medium</option>
      <option value="3">Low</option>
    </select>
    <button id="add" type="button">Add</button>
  </div>

  <div id="status" class="muted"></div>
  <ul id="list"></ul>

  <script>
    const list = document.getElementById('list');
    const title = document.getElementById('title');
    const prioritySel = document.getElementById('priority');
    const status = document.getElementById('status');

    function badge(p) {
      const span = document.createElement('span');
      if (p === 1) { span.textContent = 'High'; span.className = 'tag H'; }
      else if (p === 2) { span.textContent = 'Medium'; span.className = 'tag M'; }
      else { span.textContent = 'Low'; span.className = 'tag L'; }
      return span;
    }

    function w(p){ return p === 1 ? 3 : p === 2 ? 2 : 1; }

    async function load() {
      try {
        status.textContent = 'Loading...';
        const res = await fetch('/api/dbtodos');
        if (!res.ok) throw new Error('Failed to load todos');
        const data = await res.json();

        data.sort((a,b) =>
          (a.done - b.done) ||
          (w(b.priority ?? 2) - w(a.priority ?? 2)) ||
          (a.id - b.id)
        );

        render(data);
        status.textContent = `${data.length} task(s)`;
      } catch (err) {
        console.error(err);
        alert('Failed to load tasks.');
        status.textContent = 'Load failed';
      }
    }

    function render(items) {
      list.innerHTML = '';
      for (const it of items) {
        const li = document.createElement('li');
        if (it.done) li.classList.add('done');

        const id = document.createElement('span');
        id.textContent = `#${it.id}`;

        const text = document.createElement('span');
        text.textContent = it.title;

        const pr = badge((it.priority ?? 2));

        li.appendChild(id);
        li.appendChild(text);
        li.appendChild(pr);

        li.onclick = async () => {
          try {
            const res = await fetch(`/api/dbtodos/${it.id}/toggle`, { method: 'POST' });
            if (!res.ok) throw new Error('Toggle failed');
            load();
          } catch (err) {
            console.error(err);
            alert('Failed to toggle task.');
          }
        };

        list.appendChild(li);
      }
    }

    async function addTodo() {
      const t = title.value.trim(); if (!t) return;
      const p = parseInt(prioritySel.value, 10);
      try {
        const res = await fetch('/api/dbtodos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: t, priority: p })
        });
        if (!res.ok) throw new Error('Create failed');
        title.value = '';
        prioritySel.value = '2';
        load();
      } catch (err) {
        console.error(err);
        alert('Failed to add task.');
      }
    }

    document.getElementById('add').onclick = addTodo;
    title.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addTodo();
    });

    load();
  </script>
</body>
</html>
